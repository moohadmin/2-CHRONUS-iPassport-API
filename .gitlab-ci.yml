stages:
  - build
  - test
  - docker
  - deploy


include:
  ## build ##
  - project: devops/ship 
    file: /templates/build/.job-build-dotnet-core-sdk5.yml
  ## test ##
  - project: devops/ship 
    file: /templates/test/unit/.job-test-unit-dotnet-core-sdk5.yml
  ## docker ##
  - project: devops/ship 
    file: /templates/docker/.job-docker-gitlab-registry.yml
  ## exceptions ##
  - project: devops/ship
    file: /templates/exceptions/.retry-on-system-failures.yml    


.deploy:
  stage: deploy
  image: registry.solutis.digital/devops/build-docker-templates/google-cloud-sdk-envsubst:1.1.0
  script:
    - echo $SERVICE_ACCOUNT_KEY >> key.json
    - gcloud auth activate-service-account --key-file=key.json
    - gcloud config set project $PROJECT
    - gcloud config set compute/zone $ZONE
    - gcloud container clusters get-credentials $CLUSTER --zone $ZONE
    - for YAML in $(ls $CONFIG_DIR);do cat $CONFIG_DIR/$YAML | envsubst | kubectl apply -n ${ENVIRONMENT} -f -;done

deploy:develop:
  extends: .deploy
  variables:   
    ENVIRONMENT: dev 
    IMAGE_TAG: ${CI_REGISTRY_IMAGE}:develop
    CONFIG_DIR: config
  only:
    - develop  

deploy:release:
  extends: .deploy
  variables:    
    ENVIRONMENT: test 
    IMAGE_TAG: ${CI_REGISTRY_IMAGE}:release
    CONFIG_DIR: config
  only:
    - /^release\/[0-9.]+$/

deploy:tags:
  extends: .deploy
  variables:    
    ENVIRONMENT: test
    IMAGE_TAG:  ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
    CONFIG_DIR: config
  only:
    - tags