stages:
  - build
  - test
  - docker
  - deploy


include:
  ## build ##
  - project: devops/ship 
    file: /templates/build/.job-build-dotnet-core-sdk5.yml
  ## test ##
  - project: devops/ship 
    file: /templates/test/unit/.job-test-unit-dotnet-core-sdk5.yml
  ## docker ##
  - project: devops/ship 
    file: /templates/docker/.job-docker-gitlab-registry.yml
  ## exceptions ##
  - project: devops/ship
    file: /templates/exceptions/.retry-on-system-failures.yml    


.deploy:
  stage: deploy  
  image: "registry.solutis.digital/devops/build-docker-templates/google-cloud-sdk-envsubst:1.1.0"
  script:
    - echo $SERVICE_ACCOUNT_KEY >> key.json
    - gcloud auth activate-service-account --key-file=key.json
    - gcloud config set project $PROJECT
    - gcloud config set compute/zone $ZONE
    - gcloud container clusters get-credentials $CLUSTER --zone $ZONE
    - for YAML in $(ls .k8s/*.yaml);do cat $YAML | envsubst | kubectl apply -n $environment -f -;done
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - unknown_failure

deploy:develop:
  extends: .deploy
  variables:    
    IMAGE_TAG: ${CI_REGISTRY_IMAGE}:develop
  environment:
    name: dev
  only:
    - develop  

deploy:release:
  extends: .deploy
  variables:    
    IMAGE_TAG: ${CI_REGISTRY_IMAGE}:release
  environment:
    name: test
  only:
    - /^release\/[0-9.]+$/

deploy:tags:
  extends: .deploy
  variables:    
    IMAGE_TAG:  ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
  environment:
    name: test
  only:
    - tags
